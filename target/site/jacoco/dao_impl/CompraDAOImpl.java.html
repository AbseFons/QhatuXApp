<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CompraDAOImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QhatuXApp</a> &gt; <a href="index.source.html" class="el_package">dao_impl</a> &gt; <span class="el_source">CompraDAOImpl.java</span></div><h1>CompraDAOImpl.java</h1><pre class="source lang-java linenums">package dao_impl;

import dao.CompraDAO;
import model.Compra;
import util.MySQLConexion;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;

<span class="nc" id="L11">public class CompraDAOImpl implements CompraDAO {</span>

    @Override
    public long create(Compra c) throws Exception {
<span class="nc" id="L15">        String sql = &quot;INSERT INTO Compra (IdUsuario,IdEvento,Cantidad,PrecioUnitario,MetodoPago) &quot;</span>
                + &quot;VALUES (?,?,?,?, 'simulado')&quot;;
<span class="nc" id="L17">        try (Connection cn = MySQLConexion.getConexion(); PreparedStatement ps = cn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)) {</span>
<span class="nc" id="L18">            ps.setLong(1, c.getIdUsuario());</span>
<span class="nc" id="L19">            ps.setLong(2, c.getIdEvento());</span>
<span class="nc" id="L20">            ps.setInt(3, c.getCantidad());</span>
<span class="nc" id="L21">            ps.setDouble(4, c.getPrecioUnitario());</span>
<span class="nc" id="L22">            ps.executeUpdate();</span>
<span class="nc" id="L23">            try (ResultSet rs = ps.getGeneratedKeys()) {</span>
<span class="nc bnc" id="L24" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc" id="L25">                    return rs.getLong(1);</span>
                }
<span class="nc bnc" id="L27" title="All 2 branches missed.">            }</span>
<span class="nc bnc" id="L28" title="All 4 branches missed.">        }</span>
<span class="nc" id="L29">        return 0;</span>
    }

    @Override
    public List&lt;Compra&gt; listByUsuario(long idUsuario) throws Exception {
<span class="nc" id="L34">        String sql = &quot;SELECT c.IdCompra, c.IdUsuario, c.IdEvento, c.Cantidad, c.PrecioUnitario,&quot;</span>
                + &quot;c.Estado, c.FechaCompra, &quot;
                + &quot;e.Nombre, e.FechaInicio AS FechaEvento &quot;
                + &quot;FROM Compra c &quot;
                + &quot;JOIN Evento e ON c.IdEvento = e.IdEvento &quot;
                + &quot;WHERE c.IdUsuario = ? &quot;
                + &quot;ORDER BY c.FechaCompra DESC&quot;;
<span class="nc" id="L41">        List&lt;Compra&gt; out = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L42">        try (Connection cn = MySQLConexion.getConexion(); PreparedStatement ps = cn.prepareStatement(sql)) {</span>
<span class="nc" id="L43">            ps.setLong(1, idUsuario);</span>
<span class="nc" id="L44">            try (ResultSet rs = ps.executeQuery()) {</span>
<span class="nc bnc" id="L45" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L46">                    Compra c = new Compra();</span>
<span class="nc" id="L47">                    c.setIdCompra(rs.getLong(&quot;IdCompra&quot;));</span>
<span class="nc" id="L48">                    c.setIdUsuario(rs.getLong(&quot;IdUsuario&quot;));</span>
<span class="nc" id="L49">                    c.setIdEvento(rs.getLong(&quot;IdEvento&quot;));</span>
<span class="nc" id="L50">                    c.setCantidad(rs.getInt(&quot;Cantidad&quot;));</span>
<span class="nc" id="L51">                    c.setPrecioUnitario(rs.getDouble(&quot;PrecioUnitario&quot;));</span>
<span class="nc" id="L52">                    c.setEstado(rs.getString(&quot;Estado&quot;));</span>
<span class="nc" id="L53">                    c.setNombreEvento(rs.getString(&quot;Nombre&quot;));</span>

<span class="nc" id="L55">                    Timestamp fc = rs.getTimestamp(&quot;FechaCompra&quot;);</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">                    c.setFechaCompra(fc != null ? fc.toLocalDateTime() : null);</span>

<span class="nc" id="L58">                    Timestamp fe = rs.getTimestamp(&quot;FechaEvento&quot;);</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">                    c.setFechaEvento(fe != null ? fe.toLocalDateTime() : null);</span>

<span class="nc" id="L61">                    out.add(c);</span>
<span class="nc" id="L62">                }</span>
            }
        }
<span class="nc" id="L65">        return out;</span>
    }

    @Override
    public int totalEntradasPagadasPorEvento(long idEvento) throws Exception {
<span class="nc" id="L70">        String sql = &quot;SELECT COALESCE(SUM(Cantidad), 0) AS total &quot;</span>
                + &quot;FROM Compra &quot;
                + &quot;WHERE IdEvento = ? AND Estado = 'PAGADO'&quot;;
<span class="nc" id="L73">        try (Connection cn = MySQLConexion.getConexion(); PreparedStatement ps = cn.prepareStatement(sql)) {</span>

<span class="nc" id="L75">            ps.setLong(1, idEvento);</span>

<span class="nc" id="L77">            try (ResultSet rs = ps.executeQuery()) {</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc" id="L79">                    return rs.getInt(&quot;total&quot;);</span>
                }
<span class="nc bnc" id="L81" title="All 2 branches missed.">            }</span>
<span class="nc bnc" id="L82" title="All 4 branches missed.">        }</span>
<span class="nc" id="L83">        return 0;</span>
    }

    @Override
    public int countByUsuario(long idUsuario) throws Exception {
<span class="nc" id="L88">        String sql = &quot;SELECT COUNT(*) AS total &quot;</span>
                + &quot;FROM Compra &quot;
                + &quot;WHERE IdUsuario = ? AND Estado = 'PAGADO'&quot;;
<span class="nc" id="L91">        try (Connection cn = MySQLConexion.getConexion(); PreparedStatement ps = cn.prepareStatement(sql)) {</span>

<span class="nc" id="L93">            ps.setLong(1, idUsuario);</span>

<span class="nc" id="L95">            try (ResultSet rs = ps.executeQuery()) {</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc" id="L97">                    return rs.getInt(&quot;total&quot;);</span>
                }
<span class="nc bnc" id="L99" title="All 2 branches missed.">            }</span>
<span class="nc bnc" id="L100" title="All 4 branches missed.">        }</span>
<span class="nc" id="L101">        return 0;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>